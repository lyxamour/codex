# Codex AI 开发者指南

## 1. 项目概述

Codex AI 是一个基于 CLI 的 AI 编程工具，旨在提供高效的编程辅助和知识管理功能。本指南将帮助开发者理解 Codex 的架构设计、代码结构和开发流程。

## 2. 技术栈

- **主语言**: Rust
- **CLI 框架**: Clap
- **UI 框架**: Ratatui + Crossterm
- **知识库**: Tantivy (全文搜索) + Sled (元数据存储)
- **AI 集成**: Reqwest + Serde
- **网页抓取**: Scraper
- **代码解析**: Tree-sitter
- **异步运行时**: Tokio
- **配置管理**: Serde + TOML/YAML
- **工具系统**: YAML 格式调用 + 内置工具集

## 3. 项目架构

### 3.1 核心架构原则

1. **模块化设计**: 每个功能模块独立，通过明确的接口交互
2. **分层架构**: 清晰的分层结构，从底层工具到高层应用
3. **插件化工具系统**: 所有功能通过统一的工具系统调用
4. **配置驱动**: 通过配置文件控制行为，支持热重载
5. **异步优先**: 核心功能采用异步实现，提高性能和响应速度

### 3.2 项目目录结构

```
codex/
├── Cargo.toml                 # 项目配置和依赖
├── README.md                  # 项目说明文档
├── src/                       # 源代码目录
│   ├── main.rs                # 程序入口点
│   ├── lib.rs                 # 库入口，导出公共模块
│   ├── i18n/                  # 国际化模块
│   ├── cli/                   # 命令行处理模块
│   ├── config/                # 配置管理模块
│   ├── core/                  # 核心功能模块
│   ├── tools/                 # 工具系统模块
│   ├── knowledge/             # 知识库模块
│   ├── ai/                    # AI 集成模块
│   ├── ui/                    # 用户界面模块
│   ├── task/                  # 任务管理模块
│   ├── docs/                  # 文档模块
│   └── utils/                 # 工具函数模块
├── templates/                 # 模板目录
│   ├── prompts/               # 提示词模板
│   ├── tools/                 # 工具定义模板
│   └── projects/              # 项目模板
├── tests/                     # 测试目录
│   ├── integration/           # 集成测试
│   ├── i18n/                  # 多语言测试
│   └── fixtures/              # 测试数据
└── docs/                      # 文档目录
    ├── 用户指南.md          # 用户指南
    ├── 开发者指南.md       # 开发者指南
    └── API参考.md         # API 参考
```

### 3.3 核心模块关系

```
+----------------+     +----------------+     +----------------+
|     CLI        |     |    Core        |     |     AI         |
|  (命令行处理)    |     |  (核心逻辑)     |     |  (AI 集成)      |
+--------+-------+     +--------+-------+     +--------+-------+
         |                          |                          |
         v                          v                          v
+--------+--------------------------+--------------------------+-------+
|                           Tools                              |
|                     (工具系统)                                |
+--------+--------------------------+--------------------------+-------+
         |                          |                          |
         v                          v                          v
+--------+-------+     +--------+-------+     +--------+-------+
|  Knowledge     |     |  UI           |     |  Task          |
|  (知识库)       |     |  (用户界面)    |     |  (任务管理)     |
+--------+-------+     +--------+-------+     +--------+-------+
         |                          |                          |
         v                          v                          v
+--------+--------------------------+--------------------------+-------+
|                          Config                              |
|                      (配置管理)                              |
+--------------------------------------------------------------+
```

## 4. 核心模块详解

### 4.1 CLI 模块

CLI 模块负责处理命令行参数、解析命令并调用相应的功能。

#### 核心文件

- `src/cli/mod.rs`: CLI 模块入口
- `src/cli/args.rs`: 命令行参数定义
- `src/cli/commands.rs`: 命令处理逻辑

#### 命令定义

所有命令通过 Clap 宏定义，例如：

```rust
#[derive(Parser)]
#[command(name = "codex")]
#[command(about = "AI 编程工具")]
#[command(long_about = None)]
pub struct Cli {
    #[command(subcommand)]
    pub command: Commands,
}

#[derive(Subcommand)]
pub enum Commands {
    #[command(about = "索引代码库")]
    Index(IndexArgs),
    
    #[command(about = "询问问题")]
    Ask(AskArgs),
    
    // 其他命令...
}
```

### 4.2 核心模块

核心模块包含应用程序的核心逻辑和运行时管理。

#### 核心文件

- `src/core/mod.rs`: 核心模块入口
- `src/core/app.rs`: 应用程序核心
- `src/core/runtime.rs`: 运行时管理

#### 应用程序生命周期

1. 初始化配置
2. 加载插件
3. 初始化工具系统
4. 初始化 AI 平台
5. 处理命令
6. 清理资源

### 4.3 工具系统

工具系统是 Codex 的核心，所有功能通过统一的工具系统调用。

#### 核心文件

- `src/tools/mod.rs`: 工具系统入口
- `src/tools/registry.rs`: 工具注册表
- `src/tools/executor.rs`: 工具执行器
- `src/tools/parser.rs`: YAML 工具定义解析器
- `src/tools/builtin/`: 内置工具集
- `src/tools/external/`: 外部工具适配器

#### 工具定义格式

```yaml
name: "工具名称"
description: "工具描述"
version: "1.0.0"
category: "builtin|external|mcp"
parameters:
  - name: "参数名"
    type: "string|number|boolean|array|object"
    required: true|false
    description: "参数描述"
    default: "默认值"
execution:
  type: "builtin_function|shell_command|mcp_call"
  handler: "处理函数名或命令"
  timeout: 30 # 超时时间（秒）
```

### 4.4 知识库模块

知识库模块负责代码索引、搜索和管理。

#### 核心文件

- `src/knowledge/mod.rs`: 知识库模块入口
- `src/knowledge/base.rs`: 知识库基础
- `src/knowledge/indexer.rs`: 代码索引器
- `src/knowledge/searcher.rs`: 搜索引擎
- `src/knowledge/multilingual.rs`: 多语言代码支持
- `src/knowledge/remote.rs`: 远程知识库
- `src/knowledge/scraper/`: 网页抓取子模块

#### 索引流程

1. 扫描文件系统
2. 解析文件内容
3. 提取代码元素
4. 构建索引
5. 存储元数据

### 4.5 AI 模块

AI 模块负责与各种 AI 平台交互，提供代码生成、解释等功能。

#### 核心文件

- `src/ai/mod.rs`: AI 模块入口
- `src/ai/adapter.rs`: AI 平台适配器
- `src/ai/prompt.rs`: 提示词管理
- `src/ai/multilingual.rs`: 多语言 AI 支持
- `src/ai/chat.rs`: 对话管理

#### AI 平台抽象

```rust
pub trait AIProvider: Send + Sync {
    fn name(&self) -> &str;
    fn chat_completion(&self, messages: &[ChatMessage]) -> Result<ChatResponse, AIError>;
    // 其他方法...
}
```

### 4.6 UI 模块

UI 模块负责提供终端用户界面，包括交互式聊天、代码编辑等功能。

#### 核心文件

- `src/ui/mod.rs`: UI 模块入口
- `src/ui/terminal.rs`: 终端 UI
- `src/ui/localization.rs`: UI 本地化
- `src/ui/components/`: UI 组件
- `src/ui/theme.rs`: 主题管理

#### UI 组件

- Chat: 交互式聊天界面
- Editor: 代码编辑界面
- FileManager: 文件管理界面
- Status: 状态栏
- Charts: 可视化图表

### 4.7 配置模块

配置模块负责加载和管理配置文件。

#### 核心文件

- `src/config/mod.rs`: 配置模块入口
- `src/config/app.rs`: 应用配置
- `src/config/loader.rs`: 配置加载器

#### 配置优先级

1. 命令行参数
2. 环境变量
3. 配置文件
4. 默认值

## 5. 开发流程

### 5.1 环境设置

#### 安装 Rust

```bash
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
```

#### 克隆仓库

```bash
git clone https://github.com/lyxamour/codex.git
cd codex
```

#### 安装依赖

```bash
cargo build
```

### 5.2 开发规范

#### 代码风格

- 遵循 Rust 官方风格指南
- 使用 `rustfmt` 格式化代码
- 使用 `clippy` 进行代码检查

#### 命名规范

- 模块名: 小写字母，使用下划线分隔
- 结构体名: 驼峰命名法
- 函数名: 蛇形命名法
- 常量名: 全大写字母，使用下划线分隔
- 变量名: 蛇形命名法

#### 提交规范

- 提交信息使用中文
- 提交信息格式: `[模块名] 简要描述`
- 例如: `[cli] 添加新命令`

### 5.3 测试

#### 单元测试

单元测试位于每个模块的 `mod.rs` 文件中，使用 Rust 的测试宏：

```rust
#[cfg(test)]
mod tests {
    #[test]
    fn test_some_function() {
        // 测试逻辑
    }
}
```

#### 集成测试

集成测试位于 `tests/` 目录下，测试多个模块协同工作：

```rust
#[test]
fn test_integration() {
    // 集成测试逻辑
}
```

#### 运行测试

```bash
# 运行所有测试
cargo test

# 运行特定模块测试
cargo test --lib ai

# 运行集成测试
cargo test --tests
```

### 5.4 调试

#### 日志调试

Codex 使用 `tracing` 库进行日志记录，可以通过配置文件调整日志级别：

```yaml
logging:
  level: debug # 可选: error, warn, info, debug, trace
  file: "~/.codex/logs/app.log"
```

#### 命令行调试

使用 `--verbose` 选项查看详细日志：

```bash
codex --verbose index .
```

### 5.5 性能优化

#### 内存使用

- 避免不必要的内存分配
- 使用引用计数或弱引用管理生命周期
- 实现内存池管理

#### 并发优化

- 使用 Tokio 异步运行时
- 合理使用线程池
- 减少锁竞争
- 实现无锁数据结构

#### I/O 优化

- 使用异步 I/O
- 实现 I/O 批处理
- 优化文件读写

## 6. 插件开发

### 6.1 插件系统概述

Codex 支持插件扩展，可以通过插件增加新功能、支持新的 AI 平台或工具。

### 6.2 插件结构

插件是一个 Rust 库，实现了 Codex 的 `Plugin` trait：

```rust
pub trait Plugin: Send + Sync {
    fn name(&self) -> &str;
    fn version(&self) -> &str;
    fn description(&self) -> &str;
    fn initialize(&self, app: &App) -> Result<(), PluginError>;
    fn shutdown(&self) -> Result<(), PluginError>;
    // 其他方法...
}
```

### 6.3 插件开发流程

1. 创建插件项目
2. 实现 `Plugin` trait
3. 注册插件功能
4. 构建插件
5. 安装插件

### 6.4 插件示例

```rust
use codex::plugin::Plugin;
use codex::app::App;

struct MyPlugin;

impl Plugin for MyPlugin {
    fn name(&self) -> &str {
        "my-plugin"
    }
    
    fn version(&self) -> &str {
        "1.0.0"
    }
    
    fn description(&self) -> &str {
        "我的第一个插件"
    }
    
    fn initialize(&self, app: &App) -> Result<(), PluginError> {
        // 初始化逻辑
        Ok(())
    }
    
    fn shutdown(&self) -> Result<(), PluginError> {
        // 关闭逻辑
        Ok(())
    }
}

#[no_mangle]
pub fn get_plugin() -> Box<dyn Plugin> {
    Box::new(MyPlugin)
}
```

## 7. 工具开发

### 7.1 工具系统概述

Codex 的工具系统允许开发者创建自定义工具，扩展 Codex 的功能。

### 7.2 工具类型

1. **内置工具**: Rust 实现的内置功能
2. **外部工具**: 调用外部命令或脚本
3. **MCP 工具**: 调用 MCP 协议的外部服务

### 7.3 工具开发流程

1. 编写工具定义 YAML 文件
2. 实现工具处理逻辑
3. 注册工具
4. 测试工具

### 7.4 内置工具示例

```rust
pub async fn read_file(path: &str, encoding: Option<&str>) -> Result<String, ToolError> {
    let encoding = encoding.unwrap_or("utf-8");
    let content = tokio::fs::read_to_string(path).await?;
    Ok(content)
}
```

### 7.5 外部工具示例

外部工具通过调用外部命令或脚本实现：

```yaml
name: "external_tool"
description: "外部工具示例"
version: "1.0.0"
category: "external"
parameters:
  - name: "input"
    type: "string"
    required: true
    description: "输入参数"
execution:
  type: "shell_command"
  handler: "python3 /path/to/script.py {{input}}"
  timeout: 30
```

### 7.6 MCP 工具示例

MCP 工具通过调用 MCP 协议的外部服务实现：

```yaml
name: "mcp_example"
description: "MCP 工具示例"
version: "1.0.0"
category: "mcp"
parameters:
  - name: "query"
    type: "string"
    required: true
    description: "查询参数"
execution:
  type: "mcp_call"
  handler: "mcp_example_service"
  timeout: 60
  mcp_config:
    server_name: "example"
    server_path: "tcp://localhost:50051"
```

## 8. 提示词开发

### 8.1 提示词系统概述

Codex 的提示词系统允许开发者创建和管理提示词模板，提高 AI 响应质量。

### 8.2 提示词格式

```yaml
name: "提示词名称"
description: "提示词描述"
version: "1.0.0"
category: "coding|analysis|debugging|explanation|generation"
tags: ["标签1", "标签2", ...]
variables:
  - name: "变量名"
    type: "string|code|list"
    description: "变量描述"
    required: true|false
template: |
  提示词模板内容，使用 {{变量名}} 引用变量
examples:
  - input: "示例输入"
    output: "示例输出"
```

### 8.3 提示词优化

1. 清晰的任务描述
2. 明确的格式要求
3. 适当的上下文信息
4. 示例输入输出
5. 迭代优化

## 9. 发布流程

### 9.1 版本管理

Codex 使用语义化版本控制：

- **主版本号 (MAJOR)**: 不兼容的 API 变更
- **次版本号 (MINOR)**: 向下兼容的新功能
- **修订号 (PATCH)**: 向下兼容的问题修复

### 9.2 发布准备

1. 更新版本号
2. 编写更新日志
3. 运行所有测试
4. 构建发布版本
5. 准备发布说明

### 9.3 构建发布

#### 本地构建

```bash
# 构建发布版本
cargo build --release

# 构建特定平台版本
cargo build --release --target x86_64-unknown-linux-gnu
```

#### CI/CD 构建

Codex 使用 GitHub Actions 自动构建多平台版本，配置文件位于 `.github/workflows/build.yml`。

### 9.4 发布渠道

- GitHub Releases
- Homebrew
- APT 仓库
- 直接下载

## 10. 贡献指南

### 10.1 贡献流程

1. Fork 仓库
2. 创建特性分支
3. 实现功能或修复
4. 编写测试
5. 提交 PR
6. 代码审查
7. 合并 PR

### 10.2 贡献类型

- 代码贡献
- 文档贡献
- 测试贡献
- 翻译贡献
- 问题报告
- 功能建议

### 10.3 代码审查标准

1. 代码质量：清晰、简洁、高效
2. 测试覆盖：至少 80% 的代码覆盖率
3. 文档完整：函数、结构体、模块都有文档
4. 遵循规范：符合项目的代码风格和命名规范
5. 向后兼容：尽量保持 API 向后兼容

## 11. 技术文档

- [Rust 官方文档](https://doc.rust-lang.org/)
- [Clap 文档](https://docs.rs/clap/)
- [Ratatui 文档](https://docs.rs/ratatui/)
- [Tantivy 文档](https://docs.rs/tantivy/)
- [Tokio 文档](https://docs.rs/tokio/)

## 12. 联系方式

- GitHub Issues: https://github.com/lyxamour/codex/issues
- 社区讨论: https://github.com/lyxamour/codex/discussions
- 邮件: contact@lyxamour.com

## 13. 许可证

Codex 使用 MIT 许可证，详细信息请查看 LICENSE 文件。
